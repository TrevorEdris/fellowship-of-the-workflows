#!/usr/bin/env bash
set -euo pipefail

# Fellowship of the Workflows - Validate
# Validates workflow files for correctness

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
WORKFLOWS_DIR="$REPO_ROOT/workflows"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

show_help() {
    cat << 'EOF'
Usage: validate [options]

Validate workflow files.

Options:
  -h, --help         Show this help message
  -v, --verbose      Show each file as it's validated
  -q, --quiet        Only output errors

Checks performed:
  - Required frontmatter fields (description for rules, name/description for skills)
  - Skill directories contain SKILL.md

Examples:
  validate                     Validate all workflows
  validate --verbose           Show progress
EOF
}

verbose=false
quiet=false
errors=0
warnings=0

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--verbose)
            verbose=true
            shift
            ;;
        -q|--quiet)
            quiet=true
            shift
            ;;
        *)
            shift
            ;;
    esac
done

log_error() {
    echo -e "${RED}ERROR:${NC} $1"
    ((errors++))
}

log_warning() {
    echo -e "${YELLOW}WARNING:${NC} $1"
    ((warnings++))
}

log_ok() {
    if $verbose; then
        echo -e "${GREEN}âœ“${NC} $1"
    fi
}

log_info() {
    if ! $quiet; then
        echo "$1"
    fi
}

log_info "Validating workflows..."
log_info ""

# Validate rules
if [[ -d "$WORKFLOWS_DIR/rules" ]]; then
    for file in "$WORKFLOWS_DIR/rules"/*.mdc "$WORKFLOWS_DIR/rules"/*.md; do
        [[ -f "$file" ]] || continue
        [[ "$(basename "$file")" == ".gitkeep" ]] && continue
        
        if ! yq --front-matter=extract '.description' "$file" &>/dev/null; then
            log_warning "rules/$(basename "$file"): Missing 'description' in frontmatter"
        else
            log_ok "rules/$(basename "$file")"
        fi
    done
fi

# Validate skills
if [[ -d "$WORKFLOWS_DIR/skills" ]]; then
    for skill_dir in "$WORKFLOWS_DIR/skills"/*/; do
        [[ -d "$skill_dir" ]] || continue
        skill_name=$(basename "$skill_dir")
        
        if [[ ! -f "$skill_dir/SKILL.md" ]]; then
            log_error "skills/$skill_name: Missing SKILL.md"
            continue
        fi
        
        if ! yq --front-matter=extract '.name' "$skill_dir/SKILL.md" &>/dev/null; then
            log_warning "skills/$skill_name: Missing 'name' in SKILL.md frontmatter"
        fi
        
        if ! yq --front-matter=extract '.description' "$skill_dir/SKILL.md" &>/dev/null; then
            log_warning "skills/$skill_name: Missing 'description' in SKILL.md frontmatter"
        fi
        
        log_ok "skills/$skill_name"
    done
fi

# Validate agents
if [[ -d "$WORKFLOWS_DIR/agents" ]]; then
    for file in "$WORKFLOWS_DIR/agents"/*.md; do
        [[ -f "$file" ]] || continue
        [[ "$(basename "$file")" == ".gitkeep" ]] && continue
        
        if ! yq --front-matter=extract '.name' "$file" &>/dev/null; then
            log_warning "agents/$(basename "$file"): Missing 'name' in frontmatter"
        fi
        
        if ! yq --front-matter=extract '.description' "$file" &>/dev/null; then
            log_warning "agents/$(basename "$file"): Missing 'description' in frontmatter"
        fi
        
        log_ok "agents/$(basename "$file")"
    done
fi

log_info ""
if [[ $errors -gt 0 ]]; then
    echo -e "${RED}Validation failed: $errors errors, $warnings warnings${NC}"
    exit 1
elif [[ $warnings -gt 0 ]]; then
    echo -e "${YELLOW}Validation passed with $warnings warnings${NC}"
    exit 0
else
    echo -e "${GREEN}Validation passed${NC}"
    exit 0
fi
