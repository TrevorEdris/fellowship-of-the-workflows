#!/usr/bin/env bash
set -euo pipefail

# Fellowship of the Workflows - List
# Lists available workflows by scanning directories

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
WORKFLOWS_DIR="$REPO_ROOT/workflows"
STARTERS_DIR="$REPO_ROOT/starters"

# Colors
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

show_help() {
    cat << 'EOF'
Usage: list [options]

List available workflows and starters.

Options:
  -h, --help             Show this help message
  -T, --type <type>      Filter by type (rule, skill, agent, starter, persona)

Examples:
  list                   List all workflows and starters
  list --type skill      List all skills
  list --type starter    List all CLAUDE.md starters
EOF
}

type_filter=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -T|--type)
            type_filter="$2"
            shift 2
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            show_help
            exit 1
            ;;
    esac
done

echo ""
echo -e "${BOLD}Available Workflows${NC}"
echo "==================="
echo ""
echo -e "${CYAN}Install workflows:${NC} ./bin/install <workflow-id> <target-repo> --for <cursor|claude-code>"
echo -e "${CYAN}Install starters:${NC}  ./bin/install starters/<tier> <target-repo> --for <cursor|claude-code|both>"
echo ""

# List starters
if [[ -z "$type_filter" ]] || [[ "$type_filter" == "starter" ]]; then
    if [[ -d "$STARTERS_DIR" ]]; then
        has_starters=false
        for file in "$STARTERS_DIR"/CLAUDE.md.*; do
            [[ -f "$file" ]] || continue

            if ! $has_starters; then
                echo -e "${BOLD}starters:${NC} (CLAUDE.md / AGENTS.md templates)"
                has_starters=true
            fi

            tier="${file##*.}"
            case "$tier" in
                minimal)  desc="Bare essentials (~25 lines)" ;;
                standard) desc="Recommended defaults (~55 lines)" ;;
                full)     desc="Power user + persona system (~115 lines)" ;;
                *)        desc="" ;;
            esac

            printf "  %-30s %s\n" "starters/$tier" "$desc"
        done

        if $has_starters; then
            echo ""
        fi
    fi
fi

# List personas
if [[ -z "$type_filter" ]] || [[ "$type_filter" == "persona" ]]; then
    PERSONAS_DIR="$STARTERS_DIR/personas"
    if [[ -d "$PERSONAS_DIR" ]]; then
        has_personas=false
        for file in "$PERSONAS_DIR"/*.md; do
            [[ -f "$file" ]] || continue
            basename_file=$(basename "$file")
            # Skip template
            [[ "$basename_file" == "_template.md" ]] && continue

            if ! $has_personas; then
                echo -e "${BOLD}personas:${NC} (character voices for AI responses)"
                has_personas=true
            fi

            name="${basename_file%.md}"
            # Extract the one-liner from the blockquote on line 3 (after title)
            desc=$(sed -n '3p' "$file" | sed 's/^> *//' | head -c 50)
            [[ ${#desc} -ge 50 ]] && desc="${desc}..."

            printf "  %-20s %s\n" "$name" "$desc"
        done

        if $has_personas; then
            echo ""
            echo -e "  ${CYAN}Enable via:${NC} .claude/persona.yaml or .cursor/persona.yaml"
            echo -e "  ${CYAN}See:${NC} starters/snippets/persona-integration.md"
            echo ""
        fi
    fi
fi

# List rules
if [[ -z "$type_filter" ]] || [[ "$type_filter" == "rule" ]]; then
    if [[ -d "$WORKFLOWS_DIR/rules" ]]; then
        has_rules=false
        for file in "$WORKFLOWS_DIR/rules"/*.mdc "$WORKFLOWS_DIR/rules"/*.md; do
            [[ -f "$file" ]] || continue
            [[ "$(basename "$file")" == ".gitkeep" ]] && continue
            
            if ! $has_rules; then
                echo -e "${BOLD}rules:${NC}"
                has_rules=true
            fi
            
            name="${file##*/}"
            name="${name%.*}"
            desc=$(yq --front-matter=extract '.description // ""' "$file" 2>/dev/null || echo "")
            
            # Truncate description
            if [[ ${#desc} -gt 50 ]]; then
                desc="${desc:0:47}..."
            fi
            
            printf "  %-30s %s\n" "rules/$name" "$desc"
        done
        
        if $has_rules; then
            echo ""
        fi
    fi
fi

# List skills
if [[ -z "$type_filter" ]] || [[ "$type_filter" == "skill" ]]; then
    if [[ -d "$WORKFLOWS_DIR/skills" ]]; then
        has_skills=false
        for skill_dir in "$WORKFLOWS_DIR/skills"/*/; do
            [[ -d "$skill_dir" ]] || continue
            [[ -f "$skill_dir/SKILL.md" ]] || continue
            
            if ! $has_skills; then
                echo -e "${BOLD}skills:${NC}"
                has_skills=true
            fi
            
            skill_name=$(basename "$skill_dir")
            desc=$(yq --front-matter=extract '.description // ""' "$skill_dir/SKILL.md" 2>/dev/null || echo "")
            
            # Truncate description
            if [[ ${#desc} -gt 50 ]]; then
                desc="${desc:0:47}..."
            fi
            
            printf "  %-30s %s\n" "skills/$skill_name" "$desc"
        done
        
        if $has_skills; then
            echo ""
        fi
    fi
fi

# List agents
if [[ -z "$type_filter" ]] || [[ "$type_filter" == "agent" ]]; then
    if [[ -d "$WORKFLOWS_DIR/agents" ]]; then
        has_agents=false
        for file in "$WORKFLOWS_DIR/agents"/*.md; do
            [[ -f "$file" ]] || continue
            [[ "$(basename "$file")" == ".gitkeep" ]] && continue
            
            if ! $has_agents; then
                echo -e "${BOLD}agents:${NC}"
                has_agents=true
            fi
            
            name=$(basename "$file" .md)
            desc=$(yq --front-matter=extract '.description // ""' "$file" 2>/dev/null || echo "")
            
            # Truncate description
            if [[ ${#desc} -gt 50 ]]; then
                desc="${desc:0:47}..."
            fi
            
            printf "  %-30s %s\n" "agents/$name" "$desc"
        done
        
        if $has_agents; then
            echo ""
        fi
    fi
fi
