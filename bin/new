#!/usr/bin/env bash
set -euo pipefail

# Fellowship of the Workflows - New
# Creates a new workflow from template

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
WORKFLOWS_DIR="$REPO_ROOT/workflows"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

show_help() {
    cat << 'EOF'
Usage: new <type/name>

Create a new workflow from template.

Arguments:
  type/name          Workflow type and name (e.g., rule/code-style, skill/pr-review)

Supported types:
  rule/<name>        Rule file (stored in Cursor format, translated on install)
  skill/<name>       Skill package (works for both Cursor and Claude Code)
  agent/<name>       Agent/subagent definition

Options:
  -h, --help         Show this help message
  -y, --yes          Skip prompts, use defaults
  --no-edit          Don't open in $EDITOR after creation

Examples:
  new rule/code-style
  new skill/pr-review
  new agent/researcher
EOF
}

skip_prompts=false
no_edit=false
workflow_path=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -y|--yes)
            skip_prompts=true
            shift
            ;;
        --no-edit)
            no_edit=true
            shift
            ;;
        *)
            workflow_path="$1"
            shift
            ;;
    esac
done

if [[ -z "$workflow_path" ]]; then
    echo -e "${RED}Error: Workflow path required${NC}"
    echo ""
    show_help
    exit 1
fi

# Parse workflow path
IFS='/' read -ra parts <<< "$workflow_path"

if [[ ${#parts[@]} -lt 2 ]]; then
    echo -e "${RED}Error: Invalid workflow path. Expected format: type/name${NC}"
    show_help
    exit 1
fi

wtype="${parts[0]}"
name="${parts[1]}"

# Validate type
case "$wtype" in
    rule|skill|agent)
        ;;
    *)
        echo -e "${RED}Error: Unknown type: $wtype${NC}"
        echo "Supported types: rule, skill, agent"
        exit 1
        ;;
esac

# Get metadata from user
if $skip_prompts; then
    description="TODO: Add description"
else
    echo ""
    echo "Creating new $wtype: $name"
    echo ""
    
    read -p "Description: " description
    description="${description:-TODO: Add description}"
fi

# Create the workflow
echo ""

case "$wtype" in
    skill)
        target_dir="$WORKFLOWS_DIR/skills/$name"
        
        mkdir -p "$target_dir/references" "$target_dir/scripts" "$target_dir/assets"
        
        cat > "$target_dir/SKILL.md" << EOF
---
name: $name
description: $description
# context: fork                    # Uncomment for isolated execution
# agent: agent-name                # Uncomment to link a subagent
# allowed-tools: Read, Grep        # Uncomment to restrict tools
# --- Claude Code only (ignored by Cursor) ---
# model: sonnet                    # opus, sonnet, or haiku
# argument-hint: "[args]"          # CLI autocomplete hint
# disable-model-invocation: false  # Set true to require /command
---

# $name

$description

## When to Use

- Use this skill when...
- This skill is helpful for...

## Instructions

1. Step one
2. Step two
3. Step three

## References

See \`references/\` for additional documentation.
EOF
        
        cat > "$target_dir/references/README.md" << EOF
# References

Additional documentation for the $name skill.
EOF
        
        echo -e "${GREEN}✓${NC} Created skill at $target_dir"
        main_file="$target_dir/SKILL.md"
        ;;
    
    rule)
        target_dir="$WORKFLOWS_DIR/rules"
        target_file="$target_dir/$name.mdc"
        
        mkdir -p "$target_dir"
        
        cat > "$target_file" << EOF
---
description: $description
globs: "**/*"
alwaysApply: false
---

# $name

$description

## Guidelines

- Guideline one
- Guideline two
- Guideline three
EOF
        
        echo -e "${GREEN}✓${NC} Created rule at $target_file"
        echo -e "${YELLOW}Note:${NC} Rules are stored in Cursor format and translated automatically when installing for Claude Code"
        main_file="$target_file"
        ;;
    
    agent)
        target_dir="$WORKFLOWS_DIR/agents"
        target_file="$target_dir/$name.md"
        
        mkdir -p "$target_dir"
        
        cat > "$target_file" << EOF
---
name: $name
description: $description
tools: Bash, Glob, Grep, Read, Write
model: sonnet
---

# $name

$description

## Purpose

Describe what this agent specializes in.

## Instructions

- Instruction one
- Instruction two
- Instruction three
EOF
        
        echo -e "${GREEN}✓${NC} Created agent at $target_file"
        main_file="$target_file"
        ;;
esac

# Open in editor
if ! $no_edit && [[ -n "${EDITOR:-}" ]]; then
    echo ""
    echo "Opening in $EDITOR..."
    $EDITOR "$main_file"
elif ! $no_edit; then
    echo ""
    echo "Set \$EDITOR to automatically open new workflows"
    echo "File created at: $main_file"
fi

echo ""
echo -e "${GREEN}Done!${NC}"
