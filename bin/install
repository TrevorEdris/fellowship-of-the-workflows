#!/usr/bin/env bash
set -euo pipefail

# Fellowship of the Workflows - Install
# Deploys workflows to target repositories with tool-specific translation

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
WORKFLOWS_DIR="$REPO_ROOT/workflows"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

show_help() {
    cat << 'EOF'
Usage: install <workflow-id> <target-repo> --for <tool> [options]
       install <workflow-id> --global --for <tool>
       install <target-repo> --interactive --for <tool>

Deploy a workflow to a target repository or globally.

Arguments:
  workflow-id        Workflow to install (e.g., rules/ai-session, skills/code-review)
  target-repo        Path to target repository (not needed with --global)

Options:
  -h, --help         Show this help message
  -g, --global       Install globally to ~/.<tool>/ instead of project
  -i, --interactive  Interactive mode (pick workflow with fzf)
  -n, --dry-run      Show what would be copied without copying
  --for <tool>       Target tool (required): cursor, claude-code

The --for flag is required and determines:
  - Target directory (.cursor/ vs .claude/)
  - File extension for rules (.mdc vs .md)
  - Frontmatter translation (globs/alwaysApply vs paths)

Examples:
  # Project-level installation
  install rules/ai-session ~/my-repo --for cursor
  install skills/code-review ~/my-repo --for claude-code

  # Global installation (available in all projects)
  install rules/ai-session --global --for cursor
  install skills/code-review --global --for claude-code

  # Interactive mode
  install ~/my-repo --interactive --for cursor
  install --global --interactive --for claude-code
EOF
}

# Translate Cursor frontmatter to Claude Code format
translate_frontmatter_to_claude() {
    local input_file="$1"
    local output_file="$2"
    
    # Extract frontmatter values
    local description globs always_apply
    description=$(yq --front-matter=extract '.description // ""' "$input_file" 2>/dev/null || echo "")
    globs=$(yq --front-matter=extract '.globs // ""' "$input_file" 2>/dev/null || echo "")
    always_apply=$(yq --front-matter=extract '.alwaysApply // false' "$input_file" 2>/dev/null || echo "false")
    
    # Convert globs to paths array
    local paths_yaml=""
    if [[ -n "$globs" ]] && [[ "$globs" != "null" ]]; then
        if [[ "$globs" == "**/*" ]] || [[ "$always_apply" == "true" ]]; then
            paths_yaml='paths:
  - "**/*"'
        else
            paths_yaml="paths:
  - \"**/$globs\""
        fi
    elif [[ "$always_apply" == "true" ]]; then
        paths_yaml='paths:
  - "**/*"'
    fi
    
    # Build new frontmatter
    local new_frontmatter="---"
    if [[ -n "$description" ]] && [[ "$description" != "null" ]]; then
        new_frontmatter="$new_frontmatter
description: $description"
    fi
    if [[ -n "$paths_yaml" ]]; then
        new_frontmatter="$new_frontmatter
$paths_yaml"
    fi
    new_frontmatter="$new_frontmatter
---"
    
    # Extract content after frontmatter
    local content
    content=$(awk '
        BEGIN { in_frontmatter=0; frontmatter_count=0 }
        /^---$/ { 
            frontmatter_count++
            if (frontmatter_count == 2) { in_frontmatter=0; next }
            if (frontmatter_count == 1) { in_frontmatter=1; next }
        }
        frontmatter_count >= 2 { print }
    ' "$input_file")
    
    echo "$new_frontmatter" > "$output_file"
    echo "$content" >> "$output_file"
}

# Get all workflow IDs for fzf
get_workflow_ids() {
    # Rules
    for file in "$WORKFLOWS_DIR/rules"/*.mdc "$WORKFLOWS_DIR/rules"/*.md; do
        [[ -f "$file" ]] || continue
        [[ "$(basename "$file")" == ".gitkeep" ]] && continue
        name="${file##*/}"
        name="${name%.*}"
        desc=$(yq --front-matter=extract '.description // ""' "$file" 2>/dev/null || echo "")
        echo -e "rules/$name\t$desc"
    done
    
    # Skills
    for skill_dir in "$WORKFLOWS_DIR/skills"/*/; do
        [[ -d "$skill_dir" ]] || continue
        [[ -f "$skill_dir/SKILL.md" ]] || continue
        skill_name=$(basename "$skill_dir")
        desc=$(yq --front-matter=extract '.description // ""' "$skill_dir/SKILL.md" 2>/dev/null || echo "")
        echo -e "skills/$skill_name\t$desc"
    done
    
    # Agents
    for file in "$WORKFLOWS_DIR/agents"/*.md; do
        [[ -f "$file" ]] || continue
        [[ "$(basename "$file")" == ".gitkeep" ]] && continue
        name=$(basename "$file" .md)
        desc=$(yq --front-matter=extract '.description // ""' "$file" 2>/dev/null || echo "")
        echo -e "agents/$name\t$desc"
    done
}

workflow_id=""
target_repo=""
interactive=false
dry_run=false
global_install=false
for_tool=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -i|--interactive)
            interactive=true
            shift
            ;;
        -n|--dry-run)
            dry_run=true
            shift
            ;;
        -g|--global)
            global_install=true
            shift
            ;;
        --for)
            for_tool="$2"
            shift 2
            ;;
        *)
            if [[ -z "$workflow_id" ]]; then
                if [[ "$1" == /* ]] || [[ "$1" == ~* ]] || [[ "$1" == .* ]]; then
                    target_repo="${1/#\~/$HOME}"
                else
                    workflow_id="$1"
                fi
            elif [[ -z "$target_repo" ]]; then
                target_repo="${1/#\~/$HOME}"
            fi
            shift
            ;;
    esac
done

# Validate --for is provided
if [[ -z "$for_tool" ]]; then
    echo -e "${RED}Error: --for <tool> is required${NC}"
    echo ""
    show_help
    exit 1
fi

# Validate tool
if [[ "$for_tool" != "cursor" ]] && [[ "$for_tool" != "claude-code" ]]; then
    echo -e "${RED}Error: Invalid tool: $for_tool${NC}"
    echo "Supported tools: cursor, claude-code"
    exit 1
fi

# Set base directory for global install
if $global_install; then
    case "$for_tool" in
        cursor)
            base_dir="$HOME/.cursor"
            ;;
        claude-code)
            base_dir="$HOME/.claude"
            ;;
    esac
else
    # Validate target_repo for non-global installs
    if [[ -z "$target_repo" ]] && ! $interactive; then
        echo -e "${RED}Error: target-repo is required (or use --global)${NC}"
        echo ""
        show_help
        exit 1
    fi
    
    if [[ -n "$target_repo" ]] && [[ ! -d "$target_repo" ]]; then
        echo -e "${RED}Error: Target repository does not exist: $target_repo${NC}"
        exit 1
    fi
fi

# Interactive mode
if $interactive; then
    if ! $global_install && [[ -z "$target_repo" ]]; then
        echo -e "${RED}Error: Target repository required (or use --global)${NC}"
        show_help
        exit 1
    fi
    
    workflow_id=$(get_workflow_ids | \
        fzf --with-nth=1 --delimiter='\t' --preview='echo {2}' | \
        cut -f1)
    
    if [[ -z "$workflow_id" ]]; then
        echo "No workflow selected."
        exit 0
    fi
fi

# Validate workflow_id
if [[ -z "$workflow_id" ]]; then
    echo -e "${RED}Error: workflow-id is required${NC}"
    echo ""
    show_help
    exit 1
fi

# Parse workflow ID
IFS='/' read -ra parts <<< "$workflow_id"
wtype="${parts[0]}"
name="${parts[1]}"

# Find source path
case "$wtype" in
    rules)
        # Try .mdc first, then .md
        if [[ -f "$WORKFLOWS_DIR/rules/$name.mdc" ]]; then
            source_path="$WORKFLOWS_DIR/rules/$name.mdc"
        elif [[ -f "$WORKFLOWS_DIR/rules/$name.md" ]]; then
            source_path="$WORKFLOWS_DIR/rules/$name.md"
        else
            echo -e "${RED}Error: Rule not found: $name${NC}"
            exit 1
        fi
        ;;
    skills)
        if [[ -d "$WORKFLOWS_DIR/skills/$name" ]]; then
            source_path="$WORKFLOWS_DIR/skills/$name"
        else
            echo -e "${RED}Error: Skill not found: $name${NC}"
            exit 1
        fi
        ;;
    agents)
        if [[ -f "$WORKFLOWS_DIR/agents/$name.md" ]]; then
            source_path="$WORKFLOWS_DIR/agents/$name.md"
        else
            echo -e "${RED}Error: Agent not found: $name${NC}"
            exit 1
        fi
        ;;
    *)
        echo -e "${RED}Error: Unknown workflow type: $wtype${NC}"
        exit 1
        ;;
esac

# Determine target directory
if $global_install; then
    case "$wtype" in
        rules) target_dir="$base_dir/rules" ;;
        skills) target_dir="$base_dir/skills" ;;
        agents) target_dir="$base_dir/agents" ;;
    esac
else
    case "$for_tool" in
        cursor)
            case "$wtype" in
                rules) target_dir="$target_repo/.cursor/rules" ;;
                skills) target_dir="$target_repo/.cursor/skills" ;;
                agents) target_dir="$target_repo/.cursor/agents" ;;
            esac
            ;;
        claude-code)
            case "$wtype" in
                rules) target_dir="$target_repo/.claude/rules" ;;
                skills) target_dir="$target_repo/.claude/skills" ;;
                agents) target_dir="$target_repo/.claude/agents" ;;
            esac
            ;;
    esac
fi

# Determine target file/dir name
if [[ -d "$source_path" ]]; then
    is_dir=true
    target_path="$target_dir/$name"
else
    is_dir=false
    source_name=$(basename "$source_path")
    
    # Handle file extension translation for rules
    if [[ "$wtype" == "rules" ]]; then
        if [[ "$for_tool" == "cursor" ]]; then
            target_name="${source_name%.md}"
            [[ "$target_name" == "$source_name" ]] || target_name="${target_name}.mdc"
            [[ "$source_name" == *.mdc ]] && target_name="$source_name"
        else
            target_name="${source_name%.mdc}.md"
        fi
        target_path="$target_dir/$target_name"
    else
        target_path="$target_dir/$source_name"
    fi
fi

# Show what will happen
echo ""
echo "Workflow: $workflow_id"
echo "Tool:     $for_tool"
if $global_install; then
    case "$for_tool" in
        cursor) echo "Scope:    Global (~/.cursor/)" ;;
        claude-code) echo "Scope:    Global (~/.claude/)" ;;
    esac
else
    echo "Scope:    Project ($target_repo)"
fi
echo "Source:   $source_path"
echo "Target:   $target_path"
if [[ "$wtype" == "rules" ]] && [[ "$for_tool" == "claude-code" ]]; then
    echo "Note:     Frontmatter will be translated for Claude Code"
fi
echo ""

if $dry_run; then
    echo -e "${YELLOW}[DRY RUN] Would copy:${NC}"
    if $is_dir; then
        echo "  $source_path/ -> $target_path/"
        find "$source_path" -type f | while read -r f; do
            rel=${f#$source_path/}
            echo "    $rel"
        done
    else
        echo "  $source_path -> $target_path"
    fi
    exit 0
fi

# Create target directory if needed
mkdir -p "$target_dir"

# Copy files
if $is_dir; then
    cp -rp "$source_path" "$target_path"
    echo -e "${GREEN}✓${NC} Copied skill directory to $target_path"
else
    if [[ "$wtype" == "rules" ]] && [[ "$for_tool" == "claude-code" ]]; then
        translate_frontmatter_to_claude "$source_path" "$target_path"
        echo -e "${GREEN}✓${NC} Copied and translated $(basename "$source_path") to $target_path"
    else
        cp -p "$source_path" "$target_path"
        echo -e "${GREEN}✓${NC} Copied $(basename "$source_path") to $target_path"
    fi
fi

echo ""
echo -e "${GREEN}Installation complete!${NC}"
