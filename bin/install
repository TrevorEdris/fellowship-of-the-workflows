#!/usr/bin/env bash
set -euo pipefail

# Fellowship of the Workflows - Install
# Deploys workflows and starters to target repositories

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
WORKFLOWS_DIR="$REPO_ROOT/workflows"
STARTERS_DIR="$REPO_ROOT/starters"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

show_help() {
    cat << 'EOF'
Usage: install <workflow-id> <target-repo> --for <tool> [options]
       install <workflow-id> --global --for <tool>
       install starters/<tier> <target-repo> --for <tool> [--to-claude-dir]
       install personas <target-repo> --for <tool>
       install personas --global --for <tool>
       install <target-repo> --interactive --for <tool>
       install --all <target-repo> --for <tool>
       install --all --global --for <tool>

Deploy a workflow or starter to a target repository.

Arguments:
  workflow-id        Workflow to install (e.g., rules/ai-session, skills/code-review)
  starters/<tier>    Starter template: starters/minimal, starters/standard, starters/full
  target-repo        Path to target repository (not needed with --global)

Options:
  -h, --help         Show this help message
  -a, --all          Install all available workflows
  -f, --force        Overwrite existing files without prompting
  -g, --global       Install globally to ~/.<tool>/ instead of project
  -i, --interactive  Interactive mode (pick workflow with fzf)
  -n, --dry-run      Show what would be copied without copying
  --for <tool>       Target tool (required): cursor, claude-code, or both (starters only)
  --to-claude-dir    For starters: install CLAUDE.md to .claude/ instead of project root

The --for flag determines:
  - For workflows: target directory, file extension, frontmatter translation
  - For starters: output filename (CLAUDE.md vs AGENTS.md)

Starters:
  starters/minimal   - Bare essentials (~25 lines)
  starters/standard  - Recommended defaults (~55 lines)
  starters/full      - Power user + persona system (~115 lines)
                       (full tier automatically includes personas)

  --for claude-code  → Creates CLAUDE.md (Claude Code)
  --for cursor       → Creates AGENTS.md (Cursor + Copilot + other tools)
  --for both         → Creates both files

Personas:
  install personas <target> --for <tool>   - Install persona definitions
  install personas --global --for <tool>   - Install personas globally

  Personas are also included when using --all or starters/full

Examples:
  # Install starters
  install starters/standard ~/my-repo --for claude-code   # → CLAUDE.md
  install starters/standard ~/my-repo --for cursor        # → AGENTS.md
  install starters/standard ~/my-repo --for both          # → Both files
  install starters/full ~/my-repo --for claude-code --to-claude-dir  # → .claude/CLAUDE.md

  # Project-level workflow installation
  install rules/ai-session ~/my-repo --for cursor
  install skills/code-review ~/my-repo --for claude-code

  # Global installation (available in all projects)
  install rules/ai-session --global --for cursor
  install skills/code-review --global --for claude-code

  # Interactive mode
  install ~/my-repo --interactive --for cursor
  install --global --interactive --for claude-code

  # Install all workflows
  install --all ~/my-repo --for cursor
  install --all --global --for claude-code
EOF
}

# Install a starter template (CLAUDE.md or AGENTS.md)
install_starter() {
    local tier="$1"
    local tgt_repo="$2"
    local tool="$3"
    local to_claude_dir="$4"
    local is_dry_run="$5"
    local is_force="${6:-false}"

    # Validate tier exists
    if [[ ! -f "$STARTERS_DIR/CLAUDE.md.$tier" ]]; then
        echo -e "${RED}Error: Unknown starter tier: $tier${NC}"
        echo "Available tiers: minimal, standard, full"
        return 1
    fi

    # Determine source and target based on tool
    local sources=()
    local targets=()

    case "$tool" in
        claude-code)
            sources+=("$STARTERS_DIR/CLAUDE.md.$tier")
            if [[ "$to_claude_dir" == "true" ]]; then
                targets+=("$tgt_repo/.claude/CLAUDE.md")
            else
                targets+=("$tgt_repo/CLAUDE.md")
            fi
            ;;
        cursor)
            sources+=("$STARTERS_DIR/AGENTS.md.$tier")
            targets+=("$tgt_repo/AGENTS.md")
            ;;
        both)
            sources+=("$STARTERS_DIR/CLAUDE.md.$tier")
            sources+=("$STARTERS_DIR/AGENTS.md.$tier")
            if [[ "$to_claude_dir" == "true" ]]; then
                targets+=("$tgt_repo/.claude/CLAUDE.md")
            else
                targets+=("$tgt_repo/CLAUDE.md")
            fi
            targets+=("$tgt_repo/AGENTS.md")
            ;;
    esac

    echo ""
    echo "Starter:  $tier"
    echo "Tool:     $tool"
    for i in "${!sources[@]}"; do
        echo "Source:   ${sources[$i]}"
        echo "Target:   ${targets[$i]}"
    done
    echo ""

    if [[ "$is_dry_run" == "true" ]]; then
        echo -e "${YELLOW}[DRY RUN] Would copy:${NC}"
        for i in "${!sources[@]}"; do
            echo "  ${sources[$i]} -> ${targets[$i]}"
        done

        # Also show personas for full tier
        if [[ "$tier" == "full" ]]; then
            local personas_source="$STARTERS_DIR/personas"
            local config_source="$STARTERS_DIR/snippets/persona-config-example.yaml"
            echo ""
            echo -e "${YELLOW}[DRY RUN] Would also install personas:${NC}"

            case "$tool" in
                claude-code)
                    echo "  $personas_source/*.md -> $tgt_repo/.claude/personas/"
                    echo "  $config_source -> $tgt_repo/.claude/persona.yaml"
                    ;;
                cursor)
                    echo "  $personas_source/*.md -> $tgt_repo/.cursor/personas/"
                    echo "  $config_source -> $tgt_repo/.cursor/persona.yaml"
                    ;;
                both)
                    echo "  $personas_source/*.md -> $tgt_repo/.claude/personas/"
                    echo "  $config_source -> $tgt_repo/.claude/persona.yaml"
                    echo "  $personas_source/*.md -> $tgt_repo/.cursor/personas/"
                    echo "  $config_source -> $tgt_repo/.cursor/persona.yaml"
                    ;;
            esac

            local persona_count=$(ls -1 "$personas_source"/*.md 2>/dev/null | grep -v _template.md | wc -l | tr -d ' ')
            echo "  ($persona_count persona files)"
        fi
        return 0
    fi

    # Check if targets exist (unless force)
    if [[ "$is_force" != "true" ]]; then
        for target_path in "${targets[@]}"; do
            if [[ -f "$target_path" ]]; then
                echo -e "${YELLOW}Warning: $target_path already exists${NC}"
                read -p "Overwrite? [y/N] " -n 1 -r
                echo
                if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                    echo "Aborted."
                    return 1
                fi
                break  # Only ask once
            fi
        done
    fi

    # Copy files
    for i in "${!sources[@]}"; do
        local source_file="${sources[$i]}"
        local target_path="${targets[$i]}"

        mkdir -p "$(dirname "$target_path")"
        cp "$source_file" "$target_path"
        echo -e "${GREEN}✓${NC} Installed $(basename "$target_path")"
    done

    # For full tier, also install personas
    if [[ "$tier" == "full" ]]; then
        local personas_source="$STARTERS_DIR/personas"
        local config_source="$STARTERS_DIR/snippets/persona-config-example.yaml"

        if [[ -d "$personas_source" ]]; then
            # Determine target directories based on tool
            local persona_targets=()
            local config_targets=()

            case "$tool" in
                claude-code)
                    persona_targets+=("$tgt_repo/.claude/personas")
                    config_targets+=("$tgt_repo/.claude/persona.yaml")
                    ;;
                cursor)
                    persona_targets+=("$tgt_repo/.cursor/personas")
                    config_targets+=("$tgt_repo/.cursor/persona.yaml")
                    ;;
                both)
                    persona_targets+=("$tgt_repo/.claude/personas")
                    persona_targets+=("$tgt_repo/.cursor/personas")
                    config_targets+=("$tgt_repo/.claude/persona.yaml")
                    config_targets+=("$tgt_repo/.cursor/persona.yaml")
                    ;;
            esac

            if [[ "$is_dry_run" == "true" ]]; then
                echo -e "${YELLOW}[DRY RUN] Would also copy personas:${NC}"
                for pt in "${persona_targets[@]}"; do
                    echo "  $personas_source/ -> $pt/"
                done
                for ct in "${config_targets[@]}"; do
                    echo "  $config_source -> $ct"
                done
            else
                for pt in "${persona_targets[@]}"; do
                    mkdir -p "$pt"
                    # Copy all persona files except template
                    for pfile in "$personas_source"/*.md; do
                        [[ -f "$pfile" ]] || continue
                        local basename_pfile=$(basename "$pfile")
                        [[ "$basename_pfile" == "_template.md" ]] && continue
                        cp "$pfile" "$pt/"
                    done
                    local persona_count=$(ls -1 "$pt"/*.md 2>/dev/null | wc -l | tr -d ' ')
                    echo -e "${GREEN}✓${NC} Installed $persona_count personas to $pt/"
                done

                for ct in "${config_targets[@]}"; do
                    if [[ ! -f "$ct" ]]; then
                        cp "$config_source" "$ct"
                        echo -e "${GREEN}✓${NC} Created default persona config: $ct"
                    else
                        echo -e "${YELLOW}!${NC} Persona config already exists: $ct (skipped)"
                    fi
                done
            fi
        fi
    fi

    echo ""
    echo "Next steps:"
    echo "  1. Edit the starter file(s) to fill in your project details"
    echo "  2. Install workflows: ./bin/install skills/code-review $tgt_repo --for claude-code"
    if [[ "$tier" == "full" ]]; then
        echo "  3. Switch personas: ./bin/install skills/switch-persona $tgt_repo --for claude-code"
    fi

    return 0
}

# Translate Cursor frontmatter to Claude Code format
translate_frontmatter_to_claude() {
    local input_file="$1"
    local output_file="$2"
    
    # Extract frontmatter values
    local description globs always_apply
    description=$(yq --front-matter=extract '.description // ""' "$input_file" 2>/dev/null || echo "")
    globs=$(yq --front-matter=extract '.globs // ""' "$input_file" 2>/dev/null || echo "")
    always_apply=$(yq --front-matter=extract '.alwaysApply // false' "$input_file" 2>/dev/null || echo "false")
    
    # Convert globs to paths array
    local paths_yaml=""
    if [[ -n "$globs" ]] && [[ "$globs" != "null" ]]; then
        if [[ "$globs" == "**/*" ]] || [[ "$always_apply" == "true" ]]; then
            paths_yaml='paths:
  - "**/*"'
        else
            paths_yaml="paths:
  - \"**/$globs\""
        fi
    elif [[ "$always_apply" == "true" ]]; then
        paths_yaml='paths:
  - "**/*"'
    fi
    
    # Build new frontmatter
    local new_frontmatter="---"
    if [[ -n "$description" ]] && [[ "$description" != "null" ]]; then
        new_frontmatter="$new_frontmatter
description: $description"
    fi
    if [[ -n "$paths_yaml" ]]; then
        new_frontmatter="$new_frontmatter
$paths_yaml"
    fi
    new_frontmatter="$new_frontmatter
---"
    
    # Extract content after frontmatter
    local content
    content=$(awk '
        BEGIN { in_frontmatter=0; frontmatter_count=0 }
        /^---$/ { 
            frontmatter_count++
            if (frontmatter_count == 2) { in_frontmatter=0; next }
            if (frontmatter_count == 1) { in_frontmatter=1; next }
        }
        frontmatter_count >= 2 { print }
    ' "$input_file")
    
    echo "$new_frontmatter" > "$output_file"
    echo "$content" >> "$output_file"
}

# Install personas to target location
install_personas() {
    local tgt_repo="$1"
    local tool="$2"
    local is_global="$3"
    local is_dry_run="$4"
    local quiet="${5:-false}"

    local personas_source="$STARTERS_DIR/personas"
    local config_source="$STARTERS_DIR/snippets/persona-config-example.yaml"

    if [[ ! -d "$personas_source" ]]; then
        [[ "$quiet" != "true" ]] && echo -e "${RED}Error: Personas directory not found${NC}"
        return 1
    fi

    # Determine target directories
    local base_dir persona_target config_target
    if [[ "$is_global" == "true" ]]; then
        case "$tool" in
            cursor) base_dir="$HOME/.cursor" ;;
            claude-code) base_dir="$HOME/.claude" ;;
        esac
    else
        case "$tool" in
            cursor) base_dir="$tgt_repo/.cursor" ;;
            claude-code) base_dir="$tgt_repo/.claude" ;;
        esac
    fi

    persona_target="$base_dir/personas"
    config_target="$base_dir/persona.yaml"

    if [[ "$quiet" != "true" ]]; then
        echo ""
        echo "Personas: starters/personas/"
        echo "Tool:     $tool"
        if [[ "$is_global" == "true" ]]; then
            echo "Scope:    Global ($base_dir/)"
        else
            echo "Scope:    Project ($tgt_repo)"
        fi
        echo "Target:   $persona_target/"
        echo "Config:   $config_target"
        echo ""
    fi

    if [[ "$is_dry_run" == "true" ]]; then
        if [[ "$quiet" != "true" ]]; then
            echo -e "${YELLOW}[DRY RUN] Would copy:${NC}"
            echo "  $personas_source/ -> $persona_target/"
            for pfile in "$personas_source"/*.md; do
                [[ -f "$pfile" ]] || continue
                local bn=$(basename "$pfile")
                [[ "$bn" == "_template.md" ]] && continue
                echo "    $bn"
            done
            echo "  $config_source -> $config_target"
        fi
        return 0
    fi

    # Copy persona files
    mkdir -p "$persona_target"
    local copied_count=0
    for pfile in "$personas_source"/*.md; do
        [[ -f "$pfile" ]] || continue
        local bn=$(basename "$pfile")
        [[ "$bn" == "_template.md" ]] && continue
        cp "$pfile" "$persona_target/"
        copied_count=$((copied_count + 1))
    done

    [[ "$quiet" != "true" ]] && echo -e "${GREEN}✓${NC} Copied $copied_count personas to $persona_target/"

    # Copy config if it doesn't exist
    if [[ ! -f "$config_target" ]]; then
        cp "$config_source" "$config_target"
        [[ "$quiet" != "true" ]] && echo -e "${GREEN}✓${NC} Created default persona config: $config_target"
    else
        [[ "$quiet" != "true" ]] && echo -e "${YELLOW}!${NC} Persona config already exists: $config_target (skipped)"
    fi

    return 0
}

# Get all workflow IDs for fzf
get_workflow_ids() {
    # Rules
    for file in "$WORKFLOWS_DIR/rules"/*.mdc "$WORKFLOWS_DIR/rules"/*.md; do
        [[ -f "$file" ]] || continue
        [[ "$(basename "$file")" == ".gitkeep" ]] && continue
        name="${file##*/}"
        name="${name%.*}"
        desc=$(yq --front-matter=extract '.description // ""' "$file" 2>/dev/null || echo "")
        echo -e "rules/$name\t$desc"
    done
    
    # Skills
    for skill_dir in "$WORKFLOWS_DIR/skills"/*/; do
        [[ -d "$skill_dir" ]] || continue
        [[ -f "$skill_dir/SKILL.md" ]] || continue
        skill_name=$(basename "$skill_dir")
        desc=$(yq --front-matter=extract '.description // ""' "$skill_dir/SKILL.md" 2>/dev/null || echo "")
        echo -e "skills/$skill_name\t$desc"
    done
    
    # Agents
    for file in "$WORKFLOWS_DIR/agents"/*.md; do
        [[ -f "$file" ]] || continue
        [[ "$(basename "$file")" == ".gitkeep" ]] && continue
        name=$(basename "$file" .md)
        desc=$(yq --front-matter=extract '.description // ""' "$file" 2>/dev/null || echo "")
        echo -e "agents/$name\t$desc"
    done
}

# Install a single workflow
# Returns 0 on success, 1 on failure
install_single_workflow() {
    local wf_id="$1"
    local tgt_repo="$2"
    local tool="$3"
    local is_global="$4"
    local is_dry_run="$5"
    local is_force="${6:-false}"
    local quiet="${7:-false}"

    # Parse workflow ID
    local wtype name
    IFS='/' read -ra parts <<< "$wf_id"
    wtype="${parts[0]}"
    name="${parts[1]}"

    # Find source path
    local source_path
    case "$wtype" in
        rules)
            if [[ -f "$WORKFLOWS_DIR/rules/$name.mdc" ]]; then
                source_path="$WORKFLOWS_DIR/rules/$name.mdc"
            elif [[ -f "$WORKFLOWS_DIR/rules/$name.md" ]]; then
                source_path="$WORKFLOWS_DIR/rules/$name.md"
            else
                [[ "$quiet" != "true" ]] && echo -e "${RED}Error: Rule not found: $name${NC}"
                return 1
            fi
            ;;
        skills)
            if [[ -d "$WORKFLOWS_DIR/skills/$name" ]]; then
                source_path="$WORKFLOWS_DIR/skills/$name"
            else
                [[ "$quiet" != "true" ]] && echo -e "${RED}Error: Skill not found: $name${NC}"
                return 1
            fi
            ;;
        agents)
            if [[ -f "$WORKFLOWS_DIR/agents/$name.md" ]]; then
                source_path="$WORKFLOWS_DIR/agents/$name.md"
            else
                [[ "$quiet" != "true" ]] && echo -e "${RED}Error: Agent not found: $name${NC}"
                return 1
            fi
            ;;
        *)
            [[ "$quiet" != "true" ]] && echo -e "${RED}Error: Unknown workflow type: $wtype${NC}"
            return 1
            ;;
    esac

    # Set base directory for global install
    local base_dir target_dir
    if [[ "$is_global" == "true" ]]; then
        case "$tool" in
            cursor) base_dir="$HOME/.cursor" ;;
            claude-code) base_dir="$HOME/.claude" ;;
        esac
        case "$wtype" in
            rules) target_dir="$base_dir/rules" ;;
            skills) target_dir="$base_dir/skills" ;;
            agents) target_dir="$base_dir/agents" ;;
        esac
    else
        case "$tool" in
            cursor)
                case "$wtype" in
                    rules) target_dir="$tgt_repo/.cursor/rules" ;;
                    skills) target_dir="$tgt_repo/.cursor/skills" ;;
                    agents) target_dir="$tgt_repo/.cursor/agents" ;;
                esac
                ;;
            claude-code)
                case "$wtype" in
                    rules) target_dir="$tgt_repo/.claude/rules" ;;
                    skills) target_dir="$tgt_repo/.claude/skills" ;;
                    agents) target_dir="$tgt_repo/.claude/agents" ;;
                esac
                ;;
        esac
    fi

    # Determine target file/dir name
    local is_dir target_path
    if [[ -d "$source_path" ]]; then
        is_dir=true
        target_path="$target_dir/$name"
    else
        is_dir=false
        local source_name target_name
        source_name=$(basename "$source_path")

        if [[ "$wtype" == "rules" ]]; then
            if [[ "$tool" == "cursor" ]]; then
                target_name="${source_name%.md}"
                [[ "$target_name" == "$source_name" ]] || target_name="${target_name}.mdc"
                [[ "$source_name" == *.mdc ]] && target_name="$source_name"
            else
                target_name="${source_name%.mdc}.md"
            fi
            target_path="$target_dir/$target_name"
        else
            target_path="$target_dir/$source_name"
        fi
    fi

    # Show what will happen (unless quiet)
    if [[ "$quiet" != "true" ]]; then
        echo ""
        echo "Workflow: $wf_id"
        echo "Tool:     $tool"
        if [[ "$is_global" == "true" ]]; then
            case "$tool" in
                cursor) echo "Scope:    Global (~/.cursor/)" ;;
                claude-code) echo "Scope:    Global (~/.claude/)" ;;
            esac
        else
            echo "Scope:    Project ($tgt_repo)"
        fi
        echo "Source:   $source_path"
        echo "Target:   $target_path"
        if [[ "$wtype" == "rules" ]] && [[ "$tool" == "claude-code" ]]; then
            echo "Note:     Frontmatter will be translated for Claude Code"
        fi
        echo ""
    fi

    # Check if target exists (skip for dry-run)
    if [[ "$is_dry_run" != "true" ]] && [[ "$is_force" != "true" ]]; then
        local exists=false
        if [[ "$is_dir" == "true" ]] && [[ -d "$target_path" ]]; then
            exists=true
        elif [[ "$is_dir" != "true" ]] && [[ -f "$target_path" ]]; then
            exists=true
        fi

        if [[ "$exists" == "true" ]]; then
            echo -e "${YELLOW}Warning: $target_path already exists${NC}"
            read -p "Overwrite? [y/N] " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "Skipped."
                return 1
            fi
        fi
    fi

    if [[ "$is_dry_run" == "true" ]]; then
        if [[ "$quiet" != "true" ]]; then
            echo -e "${YELLOW}[DRY RUN] Would copy:${NC}"
            if [[ "$is_dir" == "true" ]]; then
                echo "  $source_path/ -> $target_path/"
                find "$source_path" -type f | while read -r f; do
                    rel=${f#$source_path/}
                    echo "    $rel"
                done
            else
                echo "  $source_path -> $target_path"
            fi
        fi
        return 0
    fi

    # Create target directory if needed
    mkdir -p "$target_dir"

    # Copy files
    if [[ "$is_dir" == "true" ]]; then
        cp -rp "$source_path" "$target_path"
        [[ "$quiet" != "true" ]] && echo -e "${GREEN}✓${NC} Copied skill directory to $target_path"
    else
        if [[ "$wtype" == "rules" ]] && [[ "$tool" == "claude-code" ]]; then
            translate_frontmatter_to_claude "$source_path" "$target_path"
            [[ "$quiet" != "true" ]] && echo -e "${GREEN}✓${NC} Copied and translated $(basename "$source_path") to $target_path"
        else
            cp -p "$source_path" "$target_path"
            [[ "$quiet" != "true" ]] && echo -e "${GREEN}✓${NC} Copied $(basename "$source_path") to $target_path"
        fi
    fi

    return 0
}

# Install all workflows
install_all_workflows() {
    local tgt_repo="$1"
    local tool="$2"
    local is_global="$3"
    local is_dry_run="$4"

    local success_count=0
    local fail_count=0
    local succeeded=()
    local failed=()

    echo ""
    echo "Installing all workflows..."
    echo "Tool: $tool"
    if [[ "$is_global" == "true" ]]; then
        echo "Scope: Global"
    else
        echo "Scope: Project ($tgt_repo)"
    fi
    echo ""

    while IFS=$'\t' read -r wf_id desc; do
        [[ -z "$wf_id" ]] && continue

        echo -e "${YELLOW}→${NC} Installing $wf_id..."

        if install_single_workflow "$wf_id" "$tgt_repo" "$tool" "$is_global" "$is_dry_run" "true" "true"; then
            succeeded+=("$wf_id")
            success_count=$((success_count + 1))
            echo -e "  ${GREEN}✓${NC} Done"
        else
            failed+=("$wf_id")
            fail_count=$((fail_count + 1))
            echo -e "  ${RED}✗${NC} Failed"
        fi
    done < <(get_workflow_ids)
    
    # Also install personas
    echo -e "${YELLOW}→${NC} Installing personas..."
    if install_personas "$tgt_repo" "$tool" "$is_global" "$is_dry_run" "true"; then
        succeeded+=("personas")
        success_count=$((success_count + 1))
        echo -e "  ${GREEN}✓${NC} Done"
    else
        failed+=("personas")
        fail_count=$((fail_count + 1))
        echo -e "  ${RED}✗${NC} Failed"
    fi

    # Print summary
    echo ""
    echo "═══════════════════════════════════════"
    echo "Installation Summary"
    echo "═══════════════════════════════════════"
    echo ""

    if [[ ${#succeeded[@]} -gt 0 ]]; then
        echo -e "${GREEN}Succeeded (${success_count}):${NC}"
        for wf in "${succeeded[@]}"; do
            echo -e "  ${GREEN}✓${NC} $wf"
        done
        echo ""
    fi

    if [[ ${#failed[@]} -gt 0 ]]; then
        echo -e "${RED}Failed (${fail_count}):${NC}"
        for wf in "${failed[@]}"; do
            echo -e "  ${RED}✗${NC} $wf"
        done
        echo ""
    fi

    echo "Total: $success_count succeeded, $fail_count failed"

    if [[ $fail_count -gt 0 ]]; then
        return 1
    fi
    return 0
}

workflow_id=""
target_repo=""
interactive=false
dry_run=false
force=false
global_install=false
install_all=false
for_tool=""
to_claude_dir=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -a|--all)
            install_all=true
            shift
            ;;
        -f|--force)
            force=true
            shift
            ;;
        -i|--interactive)
            interactive=true
            shift
            ;;
        -n|--dry-run)
            dry_run=true
            shift
            ;;
        -g|--global)
            global_install=true
            shift
            ;;
        --for)
            for_tool="$2"
            shift 2
            ;;
        --to-claude-dir)
            to_claude_dir=true
            shift
            ;;
        *)
            if [[ -z "$workflow_id" ]]; then
                if [[ "$1" == /* ]] || [[ "$1" == ~* ]] || [[ "$1" == .* ]]; then
                    target_repo="${1/#\~/$HOME}"
                else
                    workflow_id="$1"
                fi
            elif [[ -z "$target_repo" ]]; then
                target_repo="${1/#\~/$HOME}"
            fi
            shift
            ;;
    esac
done

# Handle personas standalone install
if [[ "$workflow_id" == "personas" ]]; then
    # Require --for flag
    if [[ -z "$for_tool" ]]; then
        echo -e "${RED}Error: --for <tool> is required${NC}"
        echo "Options: --for claude-code, --for cursor"
        echo ""
        show_help
        exit 1
    fi

    # Validate tool
    if [[ "$for_tool" != "cursor" ]] && [[ "$for_tool" != "claude-code" ]]; then
        echo -e "${RED}Error: Invalid tool: $for_tool${NC}"
        echo "Supported: cursor, claude-code"
        exit 1
    fi

    # Require target repo or global
    if [[ -z "$target_repo" ]] && [[ "$global_install" != "true" ]]; then
        echo -e "${RED}Error: target-repo is required (or use --global)${NC}"
        echo ""
        show_help
        exit 1
    fi

    if [[ -n "$target_repo" ]] && [[ ! -d "$target_repo" ]]; then
        echo -e "${RED}Error: Target repository does not exist: $target_repo${NC}"
        exit 1
    fi

    if install_personas "$target_repo" "$for_tool" "$global_install" "$dry_run" "false"; then
        echo ""
        echo -e "${GREEN}Personas installed!${NC}"
        echo ""
        echo "Next steps:"
        echo "  1. Edit persona.yaml to choose your persona and intensity"
        echo "  2. Or use: /switch-persona (if skill is installed)"
        exit 0
    else
        exit 1
    fi
fi

# Handle starters
if [[ "$workflow_id" == starters/* ]]; then
    tier="${workflow_id#starters/}"

    if [[ -z "$target_repo" ]]; then
        echo -e "${RED}Error: target-repo is required for starters${NC}"
        echo ""
        show_help
        exit 1
    fi

    if [[ ! -d "$target_repo" ]]; then
        echo -e "${RED}Error: Target repository does not exist: $target_repo${NC}"
        exit 1
    fi

    # Require --for flag for starters
    if [[ -z "$for_tool" ]]; then
        echo -e "${RED}Error: --for <tool> is required for starters${NC}"
        echo "Options: --for claude-code, --for cursor, --for both"
        echo ""
        show_help
        exit 1
    fi

    # Validate tool for starters (allows 'both' in addition to cursor/claude-code)
    if [[ "$for_tool" != "cursor" ]] && [[ "$for_tool" != "claude-code" ]] && [[ "$for_tool" != "both" ]]; then
        echo -e "${RED}Error: Invalid tool for starters: $for_tool${NC}"
        echo "Supported: cursor, claude-code, both"
        exit 1
    fi

    if install_starter "$tier" "$target_repo" "$for_tool" "$to_claude_dir" "$dry_run" "$force"; then
        echo ""
        echo -e "${GREEN}Installation complete!${NC}"
        exit 0
    else
        exit 1
    fi
fi

# Validate --for is provided (required for workflows, not starters)
if [[ -z "$for_tool" ]]; then
    echo -e "${RED}Error: --for <tool> is required${NC}"
    echo ""
    show_help
    exit 1
fi

# Validate tool
if [[ "$for_tool" != "cursor" ]] && [[ "$for_tool" != "claude-code" ]]; then
    echo -e "${RED}Error: Invalid tool: $for_tool${NC}"
    echo "Supported tools: cursor, claude-code"
    exit 1
fi

# Set base directory for global install
if $global_install; then
    case "$for_tool" in
        cursor)
            base_dir="$HOME/.cursor"
            ;;
        claude-code)
            base_dir="$HOME/.claude"
            ;;
    esac
else
    # Validate target_repo for non-global installs
    if [[ -z "$target_repo" ]] && ! $interactive && ! $install_all; then
        echo -e "${RED}Error: target-repo is required (or use --global)${NC}"
        echo ""
        show_help
        exit 1
    fi

    if [[ -z "$target_repo" ]] && $install_all; then
        echo -e "${RED}Error: target-repo is required with --all (or use --global)${NC}"
        echo ""
        show_help
        exit 1
    fi

    if [[ -n "$target_repo" ]] && [[ ! -d "$target_repo" ]]; then
        echo -e "${RED}Error: Target repository does not exist: $target_repo${NC}"
        exit 1
    fi
fi

# Handle --all mode
if $install_all; then
    install_all_workflows "$target_repo" "$for_tool" "$global_install" "$dry_run"
    exit $?
fi

# Interactive mode
if $interactive; then
    if ! $global_install && [[ -z "$target_repo" ]]; then
        echo -e "${RED}Error: Target repository required (or use --global)${NC}"
        show_help
        exit 1
    fi
    
    workflow_id=$(get_workflow_ids | \
        fzf --with-nth=1 --delimiter='\t' --preview='echo {2}' | \
        cut -f1)
    
    if [[ -z "$workflow_id" ]]; then
        echo "No workflow selected."
        exit 0
    fi
fi

# Validate workflow_id
if [[ -z "$workflow_id" ]]; then
    echo -e "${RED}Error: workflow-id is required${NC}"
    echo ""
    show_help
    exit 1
fi

# Single workflow installation
if ! install_single_workflow "$workflow_id" "$target_repo" "$for_tool" "$global_install" "$dry_run" "$force" "false"; then
    exit 1
fi

echo ""
echo -e "${GREEN}Installation complete!${NC}"
